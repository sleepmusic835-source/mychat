<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Chat</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <!-- Uploadcare Widget -->
  <script>
    UPLOADCARE_PUBLIC_KEY = "c967039e2c1646f526f0";
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

  <style>
    body { margin:0; font-family:"Segoe UI"; background:#f2f5f8; display:flex; justify-content:center; align-items:center; min-height:100vh;}
    .chat-container{width:100%;max-width:450px;height:90vh;background:white;border-radius:20px;display:flex;flex-direction:column;box-shadow:0px 10px 30px rgba(0,0,0,0.1);overflow:hidden;}
    .header{background:linear-gradient(135deg,#007bff,#6610f2);padding:20px;color:white;text-align:center;font-size:20px;font-weight:bold;}
    #messages{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;}
    .msg{max-width:75%;padding:10px 14px;border-radius:14px;word-break:break-word;animation:fadeIn 0.2s;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
    .my{align-self:flex-end;background:#cfe2ff;border-bottom-right-radius:2px;}
    .other{align-self:flex-start;background:#e2ffe8;border-bottom-left-radius:2px;}
    .time{font-size:10px;opacity:0.6;margin-top:3px;text-align:right;}
    .input-area{display:flex;padding:10px;gap:10px;background:#f0f0f0;border-top:1px solid #ddd;flex-wrap:wrap;}
    #msgInput{flex:1;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px;}
    button{padding:12px 20px;border-radius:10px;background:#007bff;border:none;color:white;font-weight:bold;cursor:pointer;transition:0.2s;}
    button:hover{background:#0056d2;}
    img, video{max-width:100%;border-radius:10px;margin-top:5px;}
  </style>
</head>
<body>

<div class="chat-container">
  <div class="header">ðŸ”¥ Super Chat Room</div>
  <div id="messages"></div>
  <div class="input-area">
    <input id="msgInput" placeholder="Ð¥Ð°Ð±Ð°Ñ€Ð»Ð°Ð¼Ð° Ð¶Ð°Ð·..." />
    <input type="hidden" role="uploadcare-uploader" id="fileInput"/>
    <button onclick="sendMsg()">âž¡</button>
  </div>
</div>

<script>
  // ------------------ Firebase ------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCxQHfCsvz2XFJgvulWzfYshK8etFbT7Uk",
    authDomain: "mychat-b4c1a.firebaseapp.com",
    databaseURL: "https://mychat-b4c1a-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mychat-b4c1a",
    storageBucket: "mychat-b4c1a.firebasestorage.app",
    messagingSenderId: "829100815620",
    appId: "1:829100815620:web:d0be535fd88c5e516b4c51"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  let userId = null;

  auth.signInAnonymously().then(user => { userId = user.user.uid; listenMessages(); });

  function listenMessages() {
    db.ref("messages").on("child_added", snapshot => { showMessage(snapshot.val()); });
  }

  function showMessage(msg) {
    const div = document.createElement("div");
    div.className = "msg " + (msg.uid === userId ? "my" : "other");

    if (msg.media_url) {
      if (msg.media_type === "image") div.innerHTML = `<img src="${msg.media_url}">`;
      else if (msg.media_type === "video") div.innerHTML = `<video src="${msg.media_url}" controls></video>`;
    }
    if (msg.text) div.innerHTML += `<div>${msg.text}</div>`;

    div.innerHTML += `<div class="time">${formatTime(msg.time)}</div>`;
    document.getElementById("messages").appendChild(div);
    scrollDown();
  }

  function formatTime(t) {
    const d = new Date(t);
    return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0");
  }
  function scrollDown() { const div = document.getElementById("messages"); div.scrollTop = div.scrollHeight; }

  // ------------------ Send Message ------------------
  async function sendMsg() {
    const text = document.getElementById("msgInput").value;
    const fileWidget = uploadcare.Widget("[role=uploadcare-uploader]");
    let media_url = null;
    let media_type = null;

    if (fileWidget.value()) {
      try {
        const fileInfo = await fileWidget.value();
        media_url = fileInfo.cdnUrl + "-/quality/better/";
        media_type = fileInfo.mimeType.startsWith("image") ? "image" : "video";
      } catch(err) {
        console.error("Uploadcare error:", err);
        alert("Ð¤Ð°Ð¹Ð» Ð¶Ò¯ÐºÑ‚ÐµÐ»Ð¼ÐµÐ´Ñ–!");
        return;
      }
    }

    db.ref("messages").push({
      uid: userId,
      text: text || "",
      media_url: media_url,
      media_type: media_type,
      time: Date.now()
    });

    document.getElementById("msgInput").value = "";
    fileWidget.value(null); // reset
  }
</script>

</body>
</html>