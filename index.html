<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nurik Chat</title>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
    body {
        font-family: Arial;
        background: #f0f0f0;
        padding: 20px;
    }
    #chatBox {
        width: 100%;
        max-width: 450px;
        height: 500px;
        overflow-y: auto;
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
    }
    .msg {
        background: #e8e8e8;
        padding: 8px 10px;
        margin: 8px 0;
        border-radius: 6px;
    }
    .chat-img {
        max-width: 200px;
        border-radius: 8px;
    }
    .chat-video {
        max-width: 250px;
        border-radius: 8px;
    }
    #online {
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: bold;
    }
</style>
</head>

<body>

<div id="online">Online: 0</div>

<div id="chatBox"></div>

<input id="msgInput" placeholder="Message..." style="width: 70%; padding: 8px;">
<button onclick="sendText()">Send</button>  
<br><br>

<input type="file" id="fileInput" accept="image/*,video/*">
<button onclick="sendFile()">Send File</button>

<script>
// ------------------------------------------------
// 1) SUPABASE INIT
// ------------------------------------------------

const SUPABASE_URL = "YOUR_URL_HERE";
const SUPABASE_KEY = "YOUR_ANON_KEY_HERE";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const userId = "user-" + Math.floor(Math.random() * 999999);

// ------------------------------------------------
// 2) REALTIME ONLINE COUNTER
// ------------------------------------------------

const presence = supabase.channel("online-room", {
    config: { presence: { key: userId } }
});

presence
    .on("presence", { event: "sync" }, () => {
        const state = presence.presenceState();
        const onlineCount = Object.keys(state).length;
        document.getElementById("online").innerText = "Online: " + onlineCount;
    })
    .subscribe();

// ------------------------------------------------
// 3) REALTIME MESSAGE LISTENER
// ------------------------------------------------

supabase
    .channel("chat-table")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, (payload) => {
        renderMessage(payload.new);
    })
    .subscribe();

// Load old messages:
loadMessages();

async function loadMessages() {
    let { data } = await supabase.from("messages").select("*").order("id", { ascending: true });
    data.forEach(m => renderMessage(m));
}

// ------------------------------------------------
// 4) RENDER MESSAGE
// ------------------------------------------------

function renderMessage(msg) {
    const box = document.getElementById("chatBox");

    if (msg.type === "text") {
        box.innerHTML += `<div class="msg"><b>${msg.user}:</b> ${msg.content}</div>`;
    }

    if (msg.type === "image") {
        box.innerHTML += `<div class="msg"><b>${msg.user}</b><br><img src="${msg.content}" class="chat-img"></div>`;
    }

    if (msg.type === "video") {
        box.innerHTML += `<div class="msg"><b>${msg.user}</b><br>
        <video controls class="chat-video">
            <source src="${msg.content}">
        </video></div>`;
    }

    box.scrollTop = box.scrollHeight;
}

// ------------------------------------------------
// 5) SEND TEXT MESSAGE
// ------------------------------------------------

async function sendText() {
    const text = document.getElementById("msgInput").value;
    if (!text) return;

    await supabase.from("messages").insert({
        user: userId,
        type: "text",
        content: text
    });

    document.getElementById("msgInput").value = "";
}

// ------------------------------------------------
// 6) SEND IMAGE / VIDEO
// ------------------------------------------------

async function sendFile() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) return;

    const filePath = `chat/${Date.now()}-${file.name}`;

    // Upload
    await supabase.storage.from("chat-files").upload(filePath, file);

    const publicUrl = supabase.storage
        .from("chat-files")
        .getPublicUrl(filePath).data.publicUrl;

    const type = file.type.startsWith("video") ? "video" : "image";

    // Insert
    await supabase.from("messages").insert({
        user: userId,
        type: type,
        content: publicUrl
    });

    document.getElementById("fileInput").value = "";
}

</script>
</body>
</html>